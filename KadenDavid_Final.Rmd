---
title: "KadenFlorsheimDavidLüdeke_Final"
author: "Kaden Florsheim & David Lüdeke"
date: "11/14/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = F,
	message = FALSE,
	warning = FALSE
)
```

```{r library}
library(tidyverse)
library(sf)
library(tigris)
library(mapview)
library(leaflet)
library(censusapi)
library(gtools)
Sys.setenv(CENSUS_KEY="9fbd5ddd430b595b8f3715733cae2b75c18be92e")
```

#Dashboard ---https://dludeke.shinyapps.io/Final_KadenFDavidL/


## SAME-SEX AND RACE EQUITY ANALYSIS
```{r loading US ACS}
# pums_2019_1yru <- getCensus(
#   name = "acs/acs1/pums",
#   vintage = 2019,
#   region = "public use microdata area:*", 
#   regionin = "state:1,2,4,5,6,8,9,10,11,12,13,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,44,45,46,47,48,49,50,51,53,54,55,56",
#   vars = c(
#     "SERIALNO", #Unique ID for each household
#     "SPORDER", #Person number
#     "PWGTP", #Total number of people
#     "CPLT", #Couple Type
#     "PINCP", #Total Persons Income
#     "RAC1P" #Recorded Detailed Race Code
#   )
# )
# saveRDS(pums_2019_1yru, "usa_pums.rds")
```

```{r ACS US}
pums_2019_1yru <- readRDS("usa_pums.rds") %>% 
  mutate(
  state =  ifelse(
      (state == 1),
       paste0("0", state),
      state),
  state =  ifelse(
      (state == 2),
       paste0("0", state),
      state),
  state =  ifelse(
      (state == 4),
       paste0("0", state),
      state),
  state =  ifelse(
      (state == 5),
       paste0("0", state),
      state),
  state =  ifelse(
      (state == 6),
       paste0("0", state),
      state),
  state =  ifelse(
      (state == 8),
       paste0("0", state),
      state),
  state =  ifelse(
      (state == 9),
       paste0("0", state),
      state),
  state_puma = paste0(state,"0", public_use_microdata_area))
    
us_pumas <-
  pumas(state = NULL, cb = T, progress_bar = F)

counties <-
  counties(state = NULL, cb = T, progress_bar = F)

us_pumas <-
  us_pumas %>% 
  st_centroid() %>% 
  .[counties, ] %>% 
  st_drop_geometry() %>% 
  left_join(us_pumas %>% select(GEOID10)) %>% 
  st_as_sf()

us_pums <-
  pums_2019_1yru %>% 
  mutate(
    PUMA = str_pad(public_use_microdata_area,5,"left","0"),
    GEOID = str_pad(state_puma,5,"left","0") 
  ) %>% 
  filter(GEOID %in% us_pumas$GEOID10)
```

```{r cleaned us}
cleaned <- us_pums %>%
  mutate(
    SPORDER = as.numeric(SPORDER),
    CPLT = as.numeric(CPLT)
  ) %>% 
  filter(
    (SPORDER %in% 1:2), #Only using head of household data so that household income is not double counted thus skewing results.
    (CPLT %in% 1:4)) #filtering out N/A
```

```{r us pop data}
us_pums_pop <-
  cleaned %>%
  filter(
    (RAC1P %in% c(1,2,3,6,9))) %>%
  mutate(
    same_sex = ifelse(
        (CPLT == 2)|(CPLT == 4),
        1,
        0
  )) %>%
  group_by(GEOID) %>%
  summarize(
    samesex = sum(same_sex, na.rm = T),
    total_pop = sum(CPLT, na.rm = T)
  ) %>%
  mutate(
    percent = samesex/total_pop*100
  ) %>%
    left_join(
    us_pumas %>%
      select(GEOID10),
    by = c("GEOID" = "GEOID10")
  ) %>%
  st_as_sf()
saveRDS(us_pums_pop, "usa_pums_pop.rds")
```


```{r map US}
pums_2019_1yru <- readRDS("usa_pums_pop.rds")

couple_pal <- colorNumeric(
  palette = "Blues",
  domain = 
    c(0,5)
)

leaflet() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addPolygons(
    data = us_pums_pop, 
    fillColor = ~couple_pal (percent),
    color = "white",
    opacity = 0.5,
    fillOpacity = 0.75,
    weight = 1,
    label = ~paste0(
      round(percent*100)/100,
      "% same-sex couples"
    ),
    highlightOptions = highlightOptions(
      weight = 2,
      opacity = 1
    )
  ) %>% 
  addLegend(
    data = us_pums_pop,
    pal = couple_pal,
    values = 0:5,
    title = "% same-sex relationships"
  )

```
#To maintain a more observable color gradient, a few outlyers were filtered out. Palm Springs was the largest and had 17.62% same-sex couples.

#Most of the PUMA's had between 0% and 2% same-sex couples. It is important to note that in this assignment the populations that we are comparing (Same-sex couples vs. Opposite Sex Couples) are vastly different sizes.

#Some races were filtered out of the US and Florida maps so that they will be easier to compare to the California map. We filtered out these races because the same-sex sample size was too small.

#Key Assumptions: We are assuming that the first two SPORDER (person numbers: 1, 2) are the two people in the relationship. Additionally, there are no census questions directly asking for sexualities, but there are questions pertaining to the gender of the two heads of households and their marital status (married or unmarried). Since we are only working with couples data, the number of people that we are using in each data set is reduced. We are including unmarried couples and assuming that they are in a cohabitation agreement. 

### USA

```{r US race / income}
us_pums_IRC <-
  cleaned %>%
  filter(
    (CPLT %in% c(2, 4)), #Filtering out opposite-sex couples
    (RAC1P %in% c(1,2,3,6,9))) %>%  #Filtering out RAC1P variables that don't have enough data (Alaska Native alone,American Indian and Alaska Native tribes specified; or American Indian or Alaska Native, not specified and no other races, Native Hawaiian and Other Pacific Islander alone)
  mutate(
    PWGTP = as.numeric(PWGTP),
    PINCP = as.numeric(PINCP),
    income =  ifelse(
      (PINCP <= 20000),
       "$20,000 or less",
      PINCP
    ),
    income = ifelse(
      (PINCP > 20001 & PINCP <= 50000),
       "$20,001 to $50,000",
      income
    ),
    income = ifelse(
      (PINCP > 50001 & PINCP <= 80000),
       "$50,001 to $80,000",
      income
    ),
    income = ifelse(
      (PINCP > 80001 & PINCP <= 100000),
       "$80,001 to $100,000",
      income
    ),
    income = ifelse(
      (PINCP > 100001 & PINCP <= 150000),
       "$100,001 to $150,000",
      income
    ),
    income = ifelse(
      (PINCP > 150001 & PINCP <= 200000),
       "$150,001 to $200,000",
      income
    ),
    income = ifelse(
      (PINCP > 200001 & PINCP <= 250000),
       "$200,001 to $250,000",
      income
    ),
    income = ifelse(
      (PINCP > 250001),
       "$250,001 or more",
      income
    ),
    race = ifelse(
      (RAC1P == 1),
      "White Only",
      RAC1P
    ),
    race = ifelse(
      (RAC1P == 2),
      "Black or African American alone",
      race
    ),
    race = ifelse(
      (RAC1P == 3),
      "American Indian alone",
      race
    ),
    race = ifelse(
      (RAC1P == 6),
      "Asian alone",
      race
    ),
    race = ifelse(
      (RAC1P == 8),
      "Some other race alone",
      race
    ),
    race = ifelse(
      (RAC1P == 9),
      "Two or More Races",
      race
    )) 
```

```{r income order}
order <- c( "$20,000 or less", "$20,001 to $50,000","$50,001 to $80,000","$80,001 to $100,000","$100,001 to $150,000","$150,001 to $200,000","$200,001 to $250,000","$250,001 or more")
```

## Individual in same-sex relationship personal income by race
```{r us same-sex equity analysis}
us_race_total <-
  us_pums_IRC %>% 
  group_by(race) %>% 
  summarize(estimate = sum(PWGTP)) %>% 
  mutate(income = "Total")

us_pums_IRC %>% 
  group_by(income, race) %>% 
  summarize(estimate = sum(PWGTP)) %>% 
  rbind(us_race_total) %>%  
  ggplot() +
  geom_bar(
    aes(
      x = income %>% factor(levels = rev(c("Total", mixedsort(order)))),
      y = estimate,
      fill = race 
    ),
    stat = "identity",
    position = "fill"
  ) +
  labs(
    x = "Household income",
    y = "Number of households",
    title = "US personal income by race: Individuals in same-sex relationships",
    fill = "Race"
  ) +
  coord_flip() +
  theme(
    legend.position = "bottom",
    legend.direction = "vertical"
  )  +
  guides(
    fill = guide_legend(
      reverse = T
    )
  )
```
##Across the US, there areobservable inequities amongst races within same-sex communities. White people make up a slightly disproportionate ammount of people making over $250,001 and also a disproportinatly low amount of people making less than $20,000. Asian American people make up a consistent proportion of people at every level. Two or more Races makes up a dispproportionate amount of people making less than $20,000. Black or African American people also make up a disproportinate amount of people making less than $20,000 and then make up a disproprtionatly low amount at higher income tiers ($50,000 and up.) This plot does suggest inequities that are particularly advantagous for white people and disadvantagous for black or African American people. 

```{r US race and income}
us_pums_IRC <-
  cleaned %>%
  filter(
    (CPLT %in% c(1, 3)), #Filtering out opposite-sex couples
    (RAC1P %in% c(1,2,3,6,9))) %>%  #Filtering out RAC1P variables that don't have enough data (Alaska Native alone,American Indian and Alaska Native tribes specified; or American Indian or Alaska Native, not specified and no other races, Native Hawaiian and Other Pacific Islander alone)
  mutate(
    PWGTP = as.numeric(PWGTP),
    PINCP = as.numeric(PINCP),
    income =  ifelse(
      (PINCP <= 20000),
       "$20,000 or less",
      PINCP
    ),
    income = ifelse(
      (PINCP > 20001 & PINCP <= 50000),
       "$20,001 to $50,000",
      income
    ),
    income = ifelse(
      (PINCP > 50001 & PINCP <= 80000),
       "$50,001 to $80,000",
      income
    ),
    income = ifelse(
      (PINCP > 80001 & PINCP <= 100000),
       "$80,001 to $100,000",
      income
    ),
    income = ifelse(
      (PINCP > 100001 & PINCP <= 150000),
       "$100,001 to $150,000",
      income
    ),
    income = ifelse(
      (PINCP > 150001 & PINCP <= 200000),
       "$150,001 to $200,000",
      income
    ),
    income = ifelse(
      (PINCP > 200001 & PINCP <= 250000),
       "$200,001 to $250,000",
      income
    ),
    income = ifelse(
      (PINCP > 250001),
       "$250,001 or more",
      income
    ),
    race = ifelse(
      (RAC1P == 1),
      "White only",
      RAC1P
    ),
    race = ifelse(
      (RAC1P == 2),
      "Black or African American alone",
      race
    ),
    race = ifelse(
      (RAC1P == 3),
      "American Indian alone",
      race
    ),
    race = ifelse(
      (RAC1P == 6),
      "Asian alone",
      race
    ),
    race = ifelse(
      (RAC1P == 9),
      "Two or More Races",
      race
    )) 
```

## Individual in opposite-sex relationship personal income by race
```{r US opposite-sex equity analysis}
us_race_total <-
  us_pums_IRC %>% 
  group_by(race) %>% 
  summarize(estimate = sum(PWGTP)) %>% 
  mutate(income = "Total")

us_pums_IRC %>% 
  group_by(income, race) %>% 
  summarize(estimate = sum(PWGTP)) %>% 
  rbind(us_race_total) %>%  
  ggplot() +
  geom_bar(
    aes(
      x = income %>% factor(levels = rev(c("Total", mixedsort(order)))),
      y = estimate,
      fill = race 
    ),
    stat = "identity",
    position = "fill"
  ) +
  labs(
    x = "Household income",
    y = "Number of households",
    title = "US personal income by race: Individuals in opposite-sex relationships",
    fill = "Race"
  ) +
  coord_flip() +
  theme(
    legend.position = "bottom",
    legend.direction = "vertical"
  )  +
  guides(
    fill = guide_legend(
      reverse = T
    )
  )
```
#Amongst people in opposite-sex relationships, similar trends prevail in the data however to a smaller degree. The proportions for White only and Two or More Races at every income tier are more consistent. Black or African American people make up a larger proportion of low-income people and a smaller proportion of high income people. Asian Americans on average make up a slightly larger proportion of high income people. 


```{r loading Florida ACS data}
# pums_2019_1yrf <- getCensus(
#   name = "acs/acs1/pums",
#   vintage = 2019,
#   region = "public use microdata area:*",
#   regionin = "state:12",
#   vars = c(
#     "SERIALNO", #Unique ID for each household
#     "SPORDER", #Person number
#     "PWGTP", #Total number of people
#     "CPLT", #Couple Type
#     "PINCP", #Total Persons Income
#     "RAC1P" #Recorded Detailed Race Code
# 
#   )
# )
# saveRDS(pums_2019_1yrf, "florida_pums.rds")
```

```{r ACS Florida}
pums_2019_1yrf <- readRDS("florida_pums.rds")

fl_pumas <-
  pumas("FL", cb = T, progress_bar = F)

counties <-
  counties("FL", cb = T, progress_bar = F)

fl_pumas <-
  fl_pumas %>% 
  st_centroid() %>% 
  .[counties, ] %>% 
  st_drop_geometry() %>% 
  left_join(fl_pumas %>% select(GEOID10)) %>% 
  st_as_sf()

fl_pums <-
  pums_2019_1yrf %>% 
  mutate(
    PUMA = str_pad(public_use_microdata_area,5,"left","0")
  ) %>% 
  filter(PUMA %in% fl_pumas$PUMACE10)
```

```{r Florida Cleaned}
cleaned <- fl_pums %>%
  mutate(
    SPORDER = as.numeric(SPORDER),
    CPLT = as.numeric(CPLT)
  ) %>% 
  filter(
    (SPORDER %in% 1:2), #Only using head of household data so that household income is not double counted thus skewing results.
    (CPLT %in% 1:4)) #filtering out N/A
```

### FLORIDA

```{r Florida Pop}
fl_pums_pop <-
  cleaned %>%
  filter(
    (RAC1P %in% c(1,2,3,6,9))) %>% 
  mutate(
    same_sex = ifelse(
        (CPLT == 2)|(CPLT == 4),
        1,
        0
  )) %>% 
  group_by(PUMA) %>% 
  summarize(
    samesex = sum(same_sex, na.rm = T),
    total_pop = sum(CPLT, na.rm = T)
  ) %>% 
  mutate(
    percent = samesex/total_pop*100
  ) %>% 
    left_join(
    fl_pumas %>% 
      select(PUMACE10),
    by = c("PUMA" = "PUMACE10")
  ) %>% 
  st_as_sf()
```

```{r Florida Map}
couple_pal <- colorNumeric(
  palette = "Blues",
  domain = 
    c(0,5)
)

leaflet() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addPolygons(
    data = fl_pums_pop, 
    fillColor = ~couple_pal (percent),
    color = "white",
    opacity = 0.5,
    fillOpacity = 0.75,
    weight = 1,
    label = ~paste0(
      round(percent*100)/100,
      "% same-sex couples"
    ),
    highlightOptions = highlightOptions(
      weight = 2,
      opacity = 1
    )
  ) %>% 
  addLegend(
    data = fl_pums_pop,
    pal = couple_pal,
    values = 0:5,
    title = "% same-sex relationships"
  )

```
#To maintain a more observable color gradient, a few outlyers were filtered out. The largest PUMA was in Fort Lauderdale and it had 6.88% same-sex couples.

#We wanted to see how the inequities in another populous state would compare to the inequities in California. We chose Florida because it is the third largest state by population (after California and Texas), but it is also more 
#diverse than Texas. 

```{r Florida Race and Income Same-Sex}
fl_pums_IRC <-
  cleaned %>%
  filter(
    (CPLT %in% c(2, 4)), #Filtering out opposite-sex couples
    (RAC1P %in% c(1,2,3,6,8,9))) %>%  #Filtering out RAC1P variables that don't have enough data (Alaska Native alone,American Indian and Alaska Native tribes specified; or American Indian or Alaska Native, not specified and no other races, Native Hawaiian and Pacific Islander alone)
  mutate(
    PWGTP = as.numeric(PWGTP),
    PINCP = as.numeric(PINCP),
    income =  ifelse(
      (PINCP <= 20000),
       "$20,000 or less",
      PINCP
    ),
    income = ifelse(
      (PINCP > 20001 & PINCP <= 50000),
       "$20,001 to $50,000",
      income
    ),
    income = ifelse(
      (PINCP > 50001 & PINCP <= 80000),
       "$50,001 to $80,000",
      income
    ),
    income = ifelse(
      (PINCP > 80001 & PINCP <= 100000),
       "$80,001 to $100,000",
      income
    ),
    income = ifelse(
      (PINCP > 100001 & PINCP <= 150000),
       "$100,001 to $150,000",
      income
    ),
    income = ifelse(
      (PINCP > 150001 & PINCP <= 200000),
       "$150,001 to $200,000",
      income
    ),
    income = ifelse(
      (PINCP > 200001 & PINCP <= 250000),
       "$200,001 to $250,000",
      income
    ),
    income = ifelse(
      (PINCP > 250001),
       "$250,001 or more",
      income
    ),
    race = ifelse(
      (RAC1P == 1),
      "White Only",
      RAC1P
    ),
    race = ifelse(
      (RAC1P == 2),
      "Black or African American alone",
      race
    ),
    race = ifelse(
      (RAC1P == 3),
      "American Indian alone",
      race
    ),
    race = ifelse(
      (RAC1P == 6),
      "Asian alone",
      race
    ),
    race = ifelse(
      (RAC1P == 8),
      "Other Race",
      race
    ),
    race = ifelse(
      (RAC1P == 9),
      "Two or More Races",
      race
    )) 
```

## Individual in same-sex relationship personal income by race
```{r Florida Equity Analysis Same-Sex}
fl_race_total <-
  fl_pums_IRC %>% 
  group_by(race) %>% 
  summarize(estimate = sum(PWGTP)) %>% 
  mutate(income = "Total")

fl_pums_IRC %>% 
  group_by(income, race) %>% 
  summarize(estimate = sum(PWGTP)) %>% 
  rbind(fl_race_total) %>%  
  ggplot() +
  geom_bar(
    aes(
      x = income %>% factor(levels = rev(c("Total", mixedsort(order)))),
      y = estimate,
      fill = race 
    ),
    stat = "identity",
    position = "fill"
  ) +
  labs(
    x = "Household income",
    y = "Number of households",
    title = "Florida personal income by race: Individuals in same-sex relationships",
    fill = "Race"
  ) +
  coord_flip() +
  theme(
    legend.position = "bottom",
    legend.direction = "vertical"
  )  +
  guides(
    fill = guide_legend(
      reverse = T
    )
  )
```
#We included 'Other Race' in this plot because the results were interesting. 
#Generally Florida's personal income equity analysis amongst people in same-sex relationships if less equitable than the national equity analysis conducted above. White people make up a disproportionatly high proportion of people making between $80,001 and $250,000. There are the only race included that appears in the $200,000 to $250,000 tier. This is most likely due the a lower sample size. Asian people make up a very low proportion of the overall population however they make up a significantly larger proportion of people making $250,001 and more. Black or African American data is similar to the national data. They make up a disproportionatly low proportion of the highest income tier and a disproportinaly high proportion of the lowest income tier.


```{r Florida Op-Sex Race Income}
fl_pums_IRC <-
  cleaned %>%
  filter(
    (CPLT %in% c(1, 3)), #Filtering out same-sex couples
    (RAC1P %in% c(1,2,3,6,8,9))) %>%  #Filtering out RAC1P variables that don't have enough data (Alaska Native alone,American Indian and Alaska Native tribes specified; or American Indian or Alaska Native, not specified and no other races, Native Hawaiian and Other Pacific Islander alone)
  mutate(
    PWGTP = as.numeric(PWGTP),
    PINCP = as.numeric(PINCP),
    income =  ifelse(
      (PINCP <= 20000),
       "$20,000 or less",
      PINCP
    ),
    income = ifelse(
      (PINCP > 20001 & PINCP <= 50000),
       "$20,001 to $50,000",
      income
    ),
    income = ifelse(
      (PINCP > 50001 & PINCP <= 80000),
       "$50,001 to $80,000",
      income
    ),
    income = ifelse(
      (PINCP > 80001 & PINCP <= 100000),
       "$80,001 to $100,000",
      income
    ),
    income = ifelse(
      (PINCP > 100001 & PINCP <= 150000),
       "$100,001 to $150,000",
      income
    ),
    income = ifelse(
      (PINCP > 150001 & PINCP <= 200000),
       "$150,001 to $200,000",
      income
    ),
    income = ifelse(
      (PINCP > 200001 & PINCP <= 250000),
       "$200,001 to $250,000",
      income
    ),
    income = ifelse(
      (PINCP > 250001),
       "$250,001 or more",
      income
    ),
    race = ifelse(
      (RAC1P == 1),
      "White Only",
      RAC1P
    ),
    race = ifelse(
      (RAC1P == 2),
      "Black or African American alone",
      race
    ),
    race = ifelse(
      (RAC1P == 3),
      "American Indian alone",
      race
    ),
    race = ifelse(
      (RAC1P == 6),
      "Asian alone",
      race
    ),
    race = ifelse(
      (RAC1P == 8),
      "Some other race alone",
      race
    ),
    race = ifelse(
      (RAC1P == 9),
      "Two or More Races",
      race
    )) 
```

## Individual in opposite-sex relationship personal income by race
```{r Op-Sex Florida Equity An}
fl_race_total <-
  fl_pums_IRC %>% 
  group_by(race) %>% 
  summarize(estimate = sum(PWGTP)) %>% 
  mutate(income = "Total")

fl_pums_IRC %>% 
  group_by(income, race) %>% 
  summarize(estimate = sum(PWGTP)) %>% 
  rbind(fl_race_total) %>%  
  ggplot() +
  geom_bar(
    aes(
      x = income %>% factor(levels = rev(c("Total", mixedsort(order)))),
      y = estimate,
      fill = race %>% factor(levels = rev(unique(fl_pums_IRC$race)))
    ),
    stat = "identity",
    position = "fill"
  ) +
  labs(
    x = "Household income",
    y = "Number of households",
    title = "Florida personal income by race: Individuals in opposite-sex relationships",
    fill = "Race"
  ) +
  coord_flip() +
  theme(
    legend.position = "bottom",
    legend.direction = "vertical"
  )  +
  guides(
    fill = guide_legend(
      reverse = T
    )
  )
```
#The results for the race-income equity analysis of people in opposite-sex relationships resembles the national results more than the equtiy analysis of people in same-sex relationships--Probably because the sample size is larger. Some other race alone and Black or African American alone make are disproportinaly represented in high income tiers ($80,000 and up.)


```{r Loading California ACS Data}
# pums_2019_1yr <- getCensus(
#   name = "acs/acs1/pums",
#   vintage = 2019,
#   region = "public use microdata area:*", 
#   regionin = "state:06",
#   vars = c(
#     "SERIALNO", #Unique ID for each household
#     "SPORDER", #Person number
#     "PWGTP", #Total number of people
#     "WGTP", #Housing Weight
#     "HINCP", #Household Income
#     "CPLT", #Couple Type
#     "FINCP", #Family Income
#     "PINCP", #Total Persons Income
#     "RAC1P", #Recorded Detailed Race Code
#     "SEX" #sex
#   )
# )
# saveRDS(pums_2019_1yr, "final_pums.rds")
```

```{r ACS CA}
pums_2019_1yr <- readRDS("final_pums.rds")

ca_pumas <-
  pumas("CA", cb = T, progress_bar = F)

counties <-
  counties("CA", cb = T, progress_bar = F)

ca_pumas <-
  ca_pumas %>% 
  st_centroid() %>% 
  .[counties, ] %>% 
  st_drop_geometry() %>% 
  left_join(ca_pumas %>% select(GEOID10)) %>% 
  st_as_sf()

ca_pums <-
  pums_2019_1yr %>% 
  mutate(
    PUMA = str_pad(public_use_microdata_area,5,"left","0")
  ) %>% 
  filter(PUMA %in% ca_pumas$PUMACE10)
```

```{r California Cleaned}
cleaned <- ca_pums %>%
  mutate(
    SPORDER = as.numeric(SPORDER),
    CPLT = as.numeric(CPLT)
  ) %>% 
  filter(
    (SPORDER %in% 1:2), #Only using head of household data so that household income is not double counted thus skewing results.
    (CPLT %in% 1:4)) #filtering out N/A
```

## CALIFORNIA

```{r California Pop}
ca_pums_pop <-
  cleaned %>%
  filter(
    (RAC1P %in% c(1,2,3,6,9))) %>% 
  mutate(
    same_sex = ifelse(
        (CPLT == 2)|(CPLT == 4),
        1,
        0
  )) %>% 
  group_by(PUMA) %>% 
  summarize(
    samesex = sum(same_sex, na.rm = T)) %>% 
    left_join(
    ca_pumas %>% 
      select(PUMACE10),
    by = c("PUMA" = "PUMACE10")
  ) %>% 
  st_as_sf()

couple_pal <- colorNumeric(
  palette = "Blues",
  domain = 
    c(0,59)
)

leaflet() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addPolygons(
    data = ca_pums_pop, 
    fillColor = ~couple_pal (samesex),
    color = "white",
    opacity = 0.5,
    fillOpacity = 0.75,
    weight = 1,
    label = ~paste0(
      samesex,
      " individuals in same-sex relationships"
    ),
    highlightOptions = highlightOptions(
      weight = 2,
      opacity = 1
    )
  ) %>% 
  addLegend(
    data = ca_pums_pop,
    pal = couple_pal,
    values = 0:58,
    title = "individuals in same-sex relationships"
  )

```

#For this map we decided to include the actual counts of people in same-sex relationships rather than the percentages.This is another reminder of the sample size and how low it is in reality. 

#To maintain a more observable color gradient, a few outlyers were filtered out. Palm Springs was the largest and had 320 people same-sex relationships.


```{r CA Race and Income}
ca_pums_IRC <-
  cleaned %>%
  filter(
    (CPLT %in% c(2, 4)), #Filtering out opposite-sex couples
    (RAC1P %in% c(1,2,3,6,9))) %>%  #Filtering out RAC1P variables that don't have enough data (Alaska Native alone,American Indian and Alaska Native tribes specified; or American Indian or Alaska Native, not specified and no other races, Native Hawaiian and Other Pacific Islander alone, Some Other Race alone)
  mutate(
    PWGTP = as.numeric(PWGTP),
    PINCP = as.numeric(PINCP),
    income =  ifelse(
      (PINCP <= 20000),
       "$20,000 or less",
      PINCP
    ),
    income = ifelse(
      (PINCP > 20001 & PINCP <= 50000),
       "$20,001 to $50,000",
      income
    ),
    income = ifelse(
      (PINCP > 50001 & PINCP <= 80000),
       "$50,001 to $80,000",
      income
    ),
    income = ifelse(
      (PINCP > 80001 & PINCP <= 100000),
       "$80,001 to $100,000",
      income
    ),
    income = ifelse(
      (PINCP > 100001 & PINCP <= 150000),
       "$100,001 to $150,000",
      income
    ),
    income = ifelse(
      (PINCP > 150001 & PINCP <= 200000),
       "$150,001 to $200,000",
      income
    ),
    income = ifelse(
      (PINCP > 200001 & PINCP <= 250000),
       "$200,001 to $250,000",
      income
    ),
    income = ifelse(
      (PINCP > 250001),
       "$250,001 or more",
      income
    ),
    race = ifelse(
      (RAC1P == 1),
      "White Only",
      RAC1P
    ),
    race = ifelse(
      (RAC1P == 2),
      "Black or African American alone",
      race
    ),
    race = ifelse(
      (RAC1P == 3),
      "American Indian alone",
      race
    ),
    race = ifelse(
      (RAC1P == 6),
      "Asian alone",
      race
    ),
    race = ifelse(
      (RAC1P == 9),
      "Two or More Races",
      race
    )) 
```

## Individual in same-sex relationship personal income by race
```{r Same-Sex CA Equity Analysis}
ca_race_total <-
  ca_pums_IRC %>% 
  group_by(race) %>% 
  summarize(estimate = sum(PWGTP)) %>% 
  mutate(income = "Total")

ca_pums_IRC %>% 
  group_by(income, race) %>% 
  summarize(estimate = sum(PWGTP)) %>% 
  rbind(ca_race_total) %>%  
  ggplot() +
  geom_bar(
    aes(
      x = income %>% factor(levels = rev(c("Total", mixedsort(order)))),
      y = estimate,
      fill = race %>% factor(levels = rev(unique(ca_pums_IRC$race)))
    ),
    stat = "identity",
    position = "fill"
  ) +
  labs(
    x = "Household income",
    y = "Number of households",
    title = "California personal income by race: Individuals in same-sex relationships",
    fill = "Race"
  ) +
  coord_flip() +
  theme(
    legend.position = "bottom",
    legend.direction = "vertical"
  )  +
  guides(
    fill = guide_legend(
      reverse = T
    )
  )
```
#This equity analysis has the least consistent data of the three for same-sex (USA, Florida, California.) White Only make up a disproportiate ammount of people making $250,000 alone but other than that they are pretty proportionate at every tier. Asian alone make up a slightly higher proportion of people making $200,001 to $250,000 and a lower proportion of people making $250,000 or more. American Indians make up a slightly higher proportion of people making between $20,001 and $50,000. Two or more races is pretty proportionate at every income tier except '$250,000 or more.' The most observable trend in Black or African American, which shrink in proportions as the income tier increases, but to a smaller degree than the other equity analysis'. The income tiers between $0 and $50,000 are consistent with the total population data.



```{r CA Race and Income Op-Sex}
ca_pums_IRC <-
  cleaned %>%
  filter(
    (CPLT %in% c(1, 3)), #Filtering out same-sex couples
    (RAC1P %in% c(1,2,3,6,9))) %>%  #Filtering out RAC1P variables that don't have enough data (Alaska Native alone,American Indian and Alaska Native tribes specified; or American Indian or Alaska Native, not specified and no other races, Native Hawaiian and Other Pacific Islander alone, Some Other Race alone)
  mutate(
    PWGTP = as.numeric(PWGTP),
    PINCP = as.numeric(PINCP),
    income =  ifelse(
      (PINCP <= 20000),
       "$20,000 or less",
      PINCP
    ),
    income = ifelse(
      (PINCP > 20001 & PINCP <= 50000),
       "$20,001 to $50,000",
      income
    ),
    income = ifelse(
      (PINCP > 50001 & PINCP <= 80000),
       "$50,001 to $80,000",
      income
    ),
    income = ifelse(
      (PINCP > 80001 & PINCP <= 100000),
       "$80,001 to $100,000",
      income
    ),
    income = ifelse(
      (PINCP > 100001 & PINCP <= 150000),
       "$100,001 to $150,000",
      income
    ),
    income = ifelse(
      (PINCP > 150001 & PINCP <= 200000),
       "$150,001 to $200,000",
      income
    ),
    income = ifelse(
      (PINCP > 200001 & PINCP <= 250000),
       "$200,001 to $250,000",
      income
    ),
    income = ifelse(
      (PINCP > 250001),
       "$250,001 or more",
      income
    ),
    race = ifelse(
      (RAC1P == 1),
      "White Only",
      RAC1P
    ),
    race = ifelse(
      (RAC1P == 2),
      "Black or African American alone",
      race
    ),
    race = ifelse(
      (RAC1P == 3),
      "American Indian alone",
      race
    ),
    race = ifelse(
      (RAC1P == 6),
      "Asian alone",
      race
    ),
    race = ifelse(
      (RAC1P == 9),
      "Two or More Races",
      race
    ))  
```

## Individual in opposite-sex relationship personal income by race
```{r Op-Sex CA equity Analysis}
ca_race_total <-
  ca_pums_IRC %>% 
  group_by(race) %>% 
  summarize(estimate = sum(PWGTP)) %>% 
  mutate(income = "Total")

ca_pums_IRC %>% 
  group_by(income, race) %>% 
  summarize(estimate = sum(PWGTP)) %>% 
  rbind(ca_race_total) %>%  
  ggplot() +
  geom_bar(
    aes(
      x = income %>% factor(levels = rev(c("Total", mixedsort(order)))),
      y = estimate,
      fill = race %>% factor(levels = rev(unique(ca_pums_IRC$race)))
    ),
    stat = "identity",
    position = "fill"
  ) +
  labs(
    x = "Household income",
    y = "Number of households",
    title = "California personal income by race: Individuals in opposite-sex relationships",
    fill = "Race"
  ) +
  coord_flip() +
  theme(
    legend.position = "bottom",
    legend.direction = "vertical"
  )  +
  guides(
    fill = guide_legend(
      reverse = T
    )
  ) 
```
#This is the most consisten equity analysis. There is a much larger proportion of Asian people in California than in Florida or USA. This data suggests that there is more racial inequity within same-sex couple groupings than opposite-sex couple groupings. 

## EQUITY ANALYSIS BETWEEN SAME-SEX COUPLES AND OPPOSITE-SEX COUPLES DISAGGREGATED BY RACE 

```{r Same-Sex making less than 50k}
ca_pums_income_same <-
  cleaned %>%
  filter(
    (RAC1P %in% c(1,2,3,6,9))) %>% 
  mutate(
    PWGTP = as.numeric(PWGTP),
    PINCP = as.numeric(PINCP),
    income =  ifelse(
      ((CPLT == 2)|(CPLT == 4)) & (PINCP <= 50000),
       1,
      0),
    same_sex = ifelse(
        (CPLT == 2)|(CPLT == 4),
        1,
        0
  )) %>% 
  group_by(PUMA) %>% 
  summarize(
    income = sum(income, na.rm = T),
    same_sex_pop = sum(same_sex, na.rm = T)
  ) %>% 
  mutate(
    percent = income/same_sex_pop*100
  ) %>% 
    left_join(
    ca_pumas %>% 
      select(PUMACE10),
    by = c("PUMA" = "PUMACE10")
  ) %>% 
  st_as_sf()

couple_pal <- colorNumeric(
  palette = "Reds",
  domain = 
    c(0,100)
)

leaflet() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addPolygons(
    data = ca_pums_income_same, 
    fillColor = ~couple_pal (percent),
    color = "white",
    opacity = 0.5,
    fillOpacity = 0.75,
    weight = 1,
    label = ~paste0(
      round(percent*100)/100,
      "% people in same-sex relationships with a personal income of less than $50,000"
    ),
    highlightOptions = highlightOptions(
      weight = 2,
      opacity = 1
    )
  ) %>% 
  addLegend(
    data = ca_pums_income_same,
    pal = couple_pal,
    values = 0:100,
    title = "% same-sex relationships"
  )

```
#This map reveals the percentage of people within each PUMA that make below $50,000 dollars. Grey PUMAs are PUMAs that did not have same-sex couple data.
#The is a large range of data. Some PUMAs have 100% low income same-sex couples and there is also a PUMA that has 0%.


```{r Op-sex  making less than 50k}
ca_pums_income_op <-
  cleaned %>%
  filter(
    (RAC1P %in% c(1,2,3,6,9))) %>% 
  mutate(
    PWGTP = as.numeric(PWGTP),
    PINCP = as.numeric(PINCP),
    income =  ifelse(
      ((CPLT == 1)|(CPLT == 3)) & (PINCP <= 50000),
       1,
      0),
    op_sex = ifelse(
        (CPLT == 1)|(CPLT == 3),
        1,
        0
  )) %>% 
  group_by(PUMA) %>% 
  summarize(
    income = sum(income, na.rm = T),
    op_sex_pop = sum(op_sex, na.rm = T)
  ) %>% 
  mutate(
    percent = income/op_sex_pop*100
  ) %>% 
    left_join(
    ca_pumas %>% 
      select(PUMACE10),
    by = c("PUMA" = "PUMACE10")
  ) %>% 
  st_as_sf()

couple_pal <- colorNumeric(
  palette = "Reds",
  domain = 
    c(0,100)
)

leaflet() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addPolygons(
    data = ca_pums_income_op, 
    fillColor = ~couple_pal (percent),
    color = "white",
    opacity = 0.5,
    fillOpacity = 0.75,
    weight = 1,
    label = ~paste0(
      round(percent*100)/100,
      "% people in opposite-sex relationships with a personal income of less than $100,000"
    ),
    highlightOptions = highlightOptions(
      weight = 2,
      opacity = 1
    )
  ) %>% 
  addLegend(
    data = ca_pums_income_op,
    pal = couple_pal,
    values = 0:100,
    title = "% opposite-sex relationships"
  )

```
#This map reveals the percentage of people within each PUMA that make below $50,000 dollars. Grey PUMAs are PUMAs that did not have opposite-sex couple data.
#This data is consistently arount the %40-%60 range.

```{r Income}
ca_pums_IRC <-
  cleaned %>%
  mutate(
    PWGTP = as.numeric(PWGTP),
    PINCP = as.numeric(PINCP),
    RAC1P = as.numeric(RAC1P),
    Same_sex_household = ifelse(
        (CPLT == 2)|(CPLT == 4), #Same-sex married couple|same-sex unmarried couple
      "Same sex couple",
      "Opposite sex couple"
    ),
    income =  ifelse(
      (PINCP <= 20000),
       "$20,000 or less",
      PINCP
    ),
    income = ifelse(
      (PINCP > 20001 & PINCP <= 50000),
       "$20,001 to $50,000",
      income
    ),
    income = ifelse(
      (PINCP > 50001 & PINCP <= 80000),
       "$50,001 to $80,000",
      income
    ),
    income = ifelse(
      (PINCP > 80001 & PINCP <= 100000),
       "$80,001 to $100,000",
      income
    ),
    income = ifelse(
      (PINCP > 100001 & PINCP <= 150000),
       "$100,001 to $150,000",
      income
    ),
    income = ifelse(
      (PINCP > 150001 & PINCP <= 200000),
       "$150,001 to $200,000",
      income
    ),
    income = ifelse(
      (PINCP > 200001 & PINCP <= 250000),
       "$200,001 to $250,000",
      income
    ),
    income = ifelse(
      (PINCP > 250001),
       "$250,001 or more",
      income
    ))
```  
 
```{r Map Income cplt}
ca_race_total <-
  ca_pums_IRC %>% 
  group_by(Same_sex_household) %>% 
  summarize(estimate = sum(PWGTP)) %>% 
  mutate(income = "Total")

ca_pums_IRC %>% 
  group_by(income, Same_sex_household) %>% 
  summarize(estimate = sum(PWGTP)) %>% 
  rbind(ca_race_total) %>%  
  ggplot() +
  geom_bar(
    aes(
      x = income %>% factor(levels = rev(c("Total", mixedsort(order)))),
      y = estimate,
      fill = Same_sex_household %>% factor(levels = rev(unique(ca_pums_IRC$Same_sex_household)))
    ),
    stat = "identity",
    position = "fill"
  ) +
  labs(
    x = "Household income",
    y = "Number of households",
    title = "California personal income by couple type",
    fill = "Couple Type"
  ) +
  coord_flip() +
  theme(
    legend.position = "bottom",
    legend.direction = "vertical"
  )  +
  guides(
    fill = guide_legend(
      reverse = T
    )
  )
```
#There does not appear to be a large change in proportions across different income tiers. Same-sex couples make up a slightly high proportion of people making $200,001 to $250,000.



## White Alone

```{r same-sex white map}
ca_pums_income_same <-
  cleaned %>%
  filter(
    (RAC1P %in% 1)) %>% #white alone 
  mutate(
    PWGTP = as.numeric(PWGTP),
    PINCP = as.numeric(PINCP),
    income =  ifelse(
      ((CPLT == 2)|(CPLT == 4)) & (PINCP <= 50000),
       1,
      0),
    same_sex = ifelse(
        (CPLT == 2)|(CPLT == 4),
        1,
        0
  )) %>% 
  group_by(PUMA) %>% 
  summarize(
    income = sum(income, na.rm = T),
    same_sex_pop = sum(same_sex, na.rm = T)
  ) %>% 
  mutate(
    percent = income/same_sex_pop*100
  ) %>% 
    left_join(
    ca_pumas %>% 
      select(PUMACE10),
    by = c("PUMA" = "PUMACE10")
  ) %>% 
  st_as_sf()

couple_pal <- colorNumeric(
  palette = "Reds",
  domain = 
    c(0,100)
)

leaflet() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addPolygons(
    data = ca_pums_income_same, 
    fillColor = ~couple_pal (percent),
    color = "white",
    opacity = 0.5,
    fillOpacity = 0.75,
    weight = 1,
    label = ~paste0(
      round(percent*100)/100,
      "% in same-sex relationships, white, and making less than $50,000"
    ),
    highlightOptions = highlightOptions(
      weight = 2,
      opacity = 1
    )
  ) %>% 
  addLegend(
    data = ca_pums_income_same,
    pal = couple_pal,
    values = 0:100,
    title = "% in same-sex relationships, white, and making less than $50,000"
  )

```

##This map reveals the percentage of people within each PUMA that make below $50,000 dollars. Grey PUMAs are PUMAs that did not have same-sex couple data.

```{r op-sex white map}
ca_pums_income_op <-
  cleaned %>%
  filter(
    (RAC1P %in% 1)) %>% #white alone  
  mutate(
    PWGTP = as.numeric(PWGTP),
    PINCP = as.numeric(PINCP),
    income =  ifelse(
      ((CPLT == 1)|(CPLT == 3)) & (PINCP <= 50000),
       1,
      0),
    op_sex = ifelse(
        (CPLT == 1)|(CPLT == 3),
        1,
        0
  )) %>% 
  group_by(PUMA) %>% 
  summarize(
    income = sum(income, na.rm = T),
    op_sex_pop = sum(op_sex, na.rm = T)
  ) %>% 
  mutate(
    percent = income/op_sex_pop*100
  ) %>% 
    left_join(
    ca_pumas %>% 
      select(PUMACE10),
    by = c("PUMA" = "PUMACE10")
  ) %>% 
  st_as_sf()

couple_pal <- colorNumeric(
  palette = "Reds",
  domain = 
    c(0,100)
)

leaflet() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addPolygons(
    data = ca_pums_income_op, 
    fillColor = ~couple_pal (percent),
    color = "white",
    opacity = 0.5,
    fillOpacity = 0.75,
    weight = 1,
    label = ~paste0(
      round(percent*100)/100,
      "% in opposite-sex relationships, white, and making less than $50,000"
    ),
    highlightOptions = highlightOptions(
      weight = 2,
      opacity = 1
    )
  ) %>% 
  addLegend(
    data = ca_pums_income_op,
    pal = couple_pal,
    values = 0:100,
    title = "% in opposite-sex relationships, white, and making less than $50,000"
  )

```

#This map reveals the percentage of people within each PUMA that make below $50,000. Grey PUMAs are PUMAs that did not have same-sex couple data.

#There appears to be a low average percentage of people making less than $50,000. PUMAS that are located in the Bay Area and near cities like Los Angeles have lower percentage than more inland PUMAS.

```{r white income}
ca_pums_IRC <-
  cleaned %>%
  mutate(
    PWGTP = as.numeric(PWGTP),
    PINCP = as.numeric(PINCP),
    Same_sex_household = ifelse(
        (CPLT == 2)|(CPLT == 4), 
      "Same sex couple",
      "Opposite sex couple"
    ),
    income =  ifelse(
      (PINCP <= 20000),
       "$20,000 or less",
      PINCP
    ),
    income = ifelse(
      (PINCP > 20001 & PINCP <= 50000),
       "$20,001 to $50,000",
      income
    ),
    income = ifelse(
      (PINCP > 50001 & PINCP <= 80000),
       "$50,001 to $80,000",
      income
    ),
    income = ifelse(
      (PINCP > 80001 & PINCP <= 100000),
       "$80,001 to $100,000",
      income
    ),
    income = ifelse(
      (PINCP > 100001 & PINCP <= 150000),
       "$100,001 to $150,000",
      income
    ),
    income = ifelse(
      (PINCP > 150001 & PINCP <= 200000),
       "$150,001 to $200,000",
      income
    ),
    income = ifelse(
      (PINCP > 200001 & PINCP <= 250000),
       "$200,001 to $250,000",
      income
    ),
    income = ifelse(
      (PINCP > 250001),
       "$250,001 or more",
      income
    ),
    RAC1P = as.numeric(RAC1P)
  ) %>% 
  filter(
    (RAC1P %in% 1)) #white alone
```

```{r white cplt equity an}
ca_white_total <-
  ca_pums_IRC %>% 
  group_by(Same_sex_household) %>% 
  summarize(estimate = sum(PWGTP)) %>% 
  mutate(income = "Total")

ca_pums_IRC %>% 
  group_by(income, Same_sex_household) %>% 
  summarize(estimate = sum(PWGTP)) %>% 
  rbind(ca_white_total) %>%  
  ggplot() +
  geom_bar(
    aes(
      x = income %>% factor(levels = rev(c("Total", mixedsort(order)))),
      y = estimate,
      fill = Same_sex_household %>% factor(levels = rev(unique(ca_pums_IRC$Same_sex_household)))
    ),
    stat = "identity",
    position = "fill"
  ) +
  labs(
    x = "Household income",
    y = "Number of households",
    title = "California household income by couple type",
    fill = "Couple Type"
  ) +
  coord_flip() +
  theme(
    legend.position = "bottom",
    legend.direction = "vertical"
  )  +
  guides(
    fill = guide_legend(
      reverse = T
    )
  )
```
#There does not appear to be a large change in proportions across different income tiers


## Black or African American alone

```{r map same-sex black}
ca_pums_income_same <-
  cleaned %>%
  filter(
    (RAC1P %in% 2)) %>% #black alone 
  mutate(
    PWGTP = as.numeric(PWGTP),
    PINCP = as.numeric(PINCP),
    income =  ifelse(
      ((CPLT == 2)|(CPLT == 4)) & (PINCP <= 50000),
       1,
      0),
    same_sex = ifelse(
        (CPLT == 2)|(CPLT == 4),
        1,
        0
  )) %>% 
  group_by(PUMA) %>% 
  summarize(
    income = sum(income, na.rm = T),
    same_sex_pop = sum(same_sex, na.rm = T)
  ) %>% 
  mutate(
    percent = income/same_sex_pop*100
  ) %>% 
    left_join(
    ca_pumas %>% 
      select(PUMACE10),
    by = c("PUMA" = "PUMACE10")
  ) %>% 
  st_as_sf()

couple_pal <- colorNumeric(
  palette = "Reds",
  domain = 
    c(0,100)
)

leaflet() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addPolygons(
    data = ca_pums_income_same, 
    fillColor = ~couple_pal (percent),
    color = "white",
    opacity = 0.5,
    fillOpacity = 0.75,
    weight = 1,
    label = ~paste0(
      round(percent*100)/100,
      "% in same-sex relationships, black, and making less than $50,000"
    ),
    highlightOptions = highlightOptions(
      weight = 2,
      opacity = 1
    )
  ) %>% 
  addLegend(
    data = ca_pums_income_same,
    pal = couple_pal,
    values = 0:100,
    title = "% in same-sex relationships, black, and making less than $50,000"
  )

```
#This map reveals the percentage of people within each PUMA that make below $50,000. Grey PUMAs are PUMAs that did not have same-sex couple data. There are many grey areas due to a small sample size and most of the PUMA's appear to be low-income.

```{r map op-sex black }
ca_pums_income_op <-
  cleaned %>%
  filter(
    (RAC1P %in% 2)) %>% #black alone  
  mutate(
    PWGTP = as.numeric(PWGTP),
    PINCP = as.numeric(PINCP),
    income =  ifelse(
      ((CPLT == 1)|(CPLT == 3)) & (PINCP <= 50000),
       1,
      0),
    op_sex = ifelse(
        (CPLT == 1)|(CPLT == 3),
        1,
        0
  )) %>% 
  group_by(PUMA) %>% 
  summarize(
    income = sum(income, na.rm = T),
    op_sex_pop = sum(op_sex, na.rm = T)
  ) %>% 
  mutate(
    percent = income/op_sex_pop*100
  ) %>% 
    left_join(
    ca_pumas %>% 
      select(PUMACE10),
    by = c("PUMA" = "PUMACE10")
  ) %>% 
  st_as_sf()

couple_pal <- colorNumeric(
  palette = "Reds",
  domain = 
    c(0,100)
)

leaflet() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addPolygons(
    data = ca_pums_income_op, 
    fillColor = ~couple_pal (percent),
    color = "white",
    opacity = 0.5,
    fillOpacity = 0.75,
    weight = 1,
    label = ~paste0(
      round(percent*100)/100,
      "% in opposite-sex relationships, black, and making less than $50,000"
    ),
    highlightOptions = highlightOptions(
      weight = 2,
      opacity = 1
    )
  ) %>% 
  addLegend(
    data = ca_pums_income_op,
    pal = couple_pal,
    values = 0:100,
    title = "% in opposite-sex relationships, black, and making less than $50,000"
  )

```
#This map reveals the percentage of people within each PUMA that make below $50,000. Grey PUMAs are PUMAs that did not have same-sex couple data.

```{r income black}
ca_pums_IRC <-
  cleaned %>%
  mutate(
    PWGTP = as.numeric(PWGTP),
    PINCP = as.numeric(PINCP),
    Same_sex_household = ifelse(
        (CPLT == 2)|(CPLT == 4), 
      "Same sex couple",
      "Opposite sex couple"
    ),
    income =  ifelse(
      (PINCP <= 20000),
       "$20,000 or less",
      PINCP
    ),
    income = ifelse(
      (PINCP > 20001 & PINCP <= 50000),
       "$20,001 to $50,000",
      income
    ),
    income = ifelse(
      (PINCP > 50001 & PINCP <= 80000),
       "$50,001 to $80,000",
      income
    ),
    income = ifelse(
      (PINCP > 80001 & PINCP <= 100000),
       "$80,001 to $100,000",
      income
    ),
    income = ifelse(
      (PINCP > 100001 & PINCP <= 150000),
       "$100,001 to $150,000",
      income
    ),
    income = ifelse(
      (PINCP > 150001 & PINCP <= 200000),
       "$150,001 to $200,000",
      income
    ),
    income = ifelse(
      (PINCP > 200001 & PINCP <= 250000),
       "$200,001 to $250,000",
      income
    ),
    income = ifelse(
      (PINCP > 250001),
       "$250,001 or more",
      income
    ),
    RAC1P = as.numeric(RAC1P)
  ) %>% 
  filter(
    (RAC1P %in% 2)) #Black or African American alone
```


```{r black cplt equity analysis}
ca_black_total <-
  ca_pums_IRC %>% 
  group_by(Same_sex_household) %>% 
  summarize(estimate = sum(PWGTP)) %>% 
  mutate(income = "Total")

ca_pums_IRC %>% 
  group_by(income, Same_sex_household) %>% 
  summarize(estimate = sum(PWGTP)) %>% 
  rbind(ca_black_total) %>%  
  ggplot() +
  geom_bar(
    aes(
      x = income %>% factor(levels = rev(c("Total", mixedsort(order)))),
      y = estimate,
      fill = Same_sex_household %>% factor(levels = rev(unique(ca_pums_IRC$Same_sex_household)))
    ),
    stat = "identity",
    position = "fill"
  ) +
  labs(
    x = "Household income",
    y = "Number of households",
    title = "California household income by couple type",
    fill = "Couple Type"
  ) +
  coord_flip() +
  theme(
    legend.position = "bottom",
    legend.direction = "vertical"
  )  +
  guides(
    fill = guide_legend(
      reverse = T
    )
  )
```
There does not appear to be a large change in proportions across different income tiers. Same-sex couples make up a larger proportion of people making $200,001 to $250,000.


Asian American Alone

```{r asian map same-sex}
ca_pums_income_same <-
  cleaned %>%
  filter(
    (RAC1P %in% 6)) %>% #Asian alone 
  mutate(
    PWGTP = as.numeric(PWGTP),
    PINCP = as.numeric(PINCP),
    income =  ifelse(
      ((CPLT == 2)|(CPLT == 4)) & (PINCP <= 50000),
       1,
      0),
    same_sex = ifelse(
        (CPLT == 2)|(CPLT == 4),
        1,
        0
  )) %>% 
  group_by(PUMA) %>% 
  summarize(
    income = sum(income, na.rm = T),
    same_sex_pop = sum(same_sex, na.rm = T)
  ) %>% 
  mutate(
    percent = income/same_sex_pop*100
  ) %>% 
    left_join(
    ca_pumas %>% 
      select(PUMACE10),
    by = c("PUMA" = "PUMACE10")
  ) %>% 
  st_as_sf()

couple_pal <- colorNumeric(
  palette = "Reds",
  domain = 
    c(0,100)
)

leaflet() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addPolygons(
    data = ca_pums_income_same, 
    fillColor = ~couple_pal (percent),
    color = "white",
    opacity = 0.5,
    fillOpacity = 0.75,
    weight = 1,
    label = ~paste0(
      round(percent*100)/100,
      "% people in white same-sex relationships with a personal income of less than $100,000"
    ),
    highlightOptions = highlightOptions(
      weight = 2,
      opacity = 1
    )
  ) %>% 
  addLegend(
    data = ca_pums_income_same,
    pal = couple_pal,
    values = 0:100,
    title = "% same-sex relationships"
  )

```

```{r Asian map op-sex}
ca_pums_income_op <-
  cleaned %>%
  filter(
    (RAC1P %in% 6)) %>% #Asian alone  
  mutate(
    PWGTP = as.numeric(PWGTP),
    PINCP = as.numeric(PINCP),
    income =  ifelse(
      ((CPLT == 1)|(CPLT == 3)) & (PINCP <= 50000),
       1,
      0),
    op_sex = ifelse(
        (CPLT == 1)|(CPLT == 3),
        1,
        0
  )) %>% 
  group_by(PUMA) %>% 
  summarize(
    income = sum(income, na.rm = T),
    op_sex_pop = sum(op_sex, na.rm = T)
  ) %>% 
  mutate(
    percent = income/op_sex_pop*100
  ) %>% 
    left_join(
    ca_pumas %>% 
      select(PUMACE10),
    by = c("PUMA" = "PUMACE10")
  ) %>% 
  st_as_sf()

couple_pal <- colorNumeric(
  palette = "Reds",
  domain = 
    c(0,100)
)

leaflet() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addPolygons(
    data = ca_pums_income_op, 
    fillColor = ~couple_pal (percent),
    color = "white",
    opacity = 0.5,
    fillOpacity = 0.75,
    weight = 1,
    label = ~paste0(
      round(percent*100)/100,
      "% white people in opposite-sex relationships with a personal income of less than $100,000"
    ),
    highlightOptions = highlightOptions(
      weight = 2,
      opacity = 1
    )
  ) %>% 
  addLegend(
    data = ca_pums_income_op,
    pal = couple_pal,
    values = 0:100,
    title = "% opposite-sex relationships"
  )

```

```{r Asian Income}
ca_pums_IRC <-
  cleaned %>%
  mutate(
    PWGTP = as.numeric(PWGTP),
    PINCP = as.numeric(PINCP),
    Same_sex_household = ifelse(
        (CPLT == 2)|(CPLT == 4), 
      "Same sex couple",
      "Opposite sex couple"
    ),
    income =  ifelse(
      (PINCP <= 20000),
       "$20,000 or less",
      PINCP
    ),
    income = ifelse(
      (PINCP > 20001 & PINCP <= 50000),
       "$20,001 to $50,000",
      income
    ),
    income = ifelse(
      (PINCP > 50001 & PINCP <= 80000),
       "$50,001 to $80,000",
      income
    ),
    income = ifelse(
      (PINCP > 80001 & PINCP <= 100000),
       "$80,001 to $100,000",
      income
    ),
    income = ifelse(
      (PINCP > 100001 & PINCP <= 150000),
       "$100,001 to $150,000",
      income
    ),
    income = ifelse(
      (PINCP > 150001 & PINCP <= 200000),
       "$150,001 to $200,000",
      income
    ),
    income = ifelse(
      (PINCP > 200001 & PINCP <= 250000),
       "$200,001 to $250,000",
      income
    ),
    income = ifelse(
      (PINCP > 250001),
       "$250,001 or more",
      income
    ),
    RAC1P = as.numeric(RAC1P)
  ) %>% 
  filter(
    (RAC1P %in% 6)) #Asian American alone
```

```{r Asian CPLT Equity AN}
ca_asian_total <-
  ca_pums_IRC %>% 
  group_by(Same_sex_household) %>% 
  summarize(estimate = sum(PWGTP)) %>% 
  mutate(income = "Total")

ca_pums_IRC %>% 
  group_by(income, Same_sex_household) %>% 
  summarize(estimate = sum(PWGTP)) %>% 
  rbind(ca_asian_total) %>%  
  ggplot() +
  geom_bar(
    aes(
      x = income %>% factor(levels = rev(c("Total", mixedsort(order)))),
      y = estimate,
      fill = Same_sex_household %>% factor(levels = rev(unique(ca_pums_IRC$Same_sex_household)))
    ),
    stat = "identity",
    position = "fill"
  ) +
  labs(
    x = "Household income",
    y = "Number of households",
    title = "California household income by couple type",
    fill = "Couple Type"
  ) +
  coord_flip() +
  theme(
    legend.position = "bottom",
    legend.direction = "vertical"
  )  +
  guides(
    fill = guide_legend(
      reverse = T
    )
  )
```

```{r American Indian Alone}
ca_pums_IRC <-
  cleaned %>%
  mutate(
    PWGTP = as.numeric(PWGTP),
    PINCP = as.numeric(PINCP),
    Same_sex_household = ifelse(
        (CPLT == 2)|(CPLT == 4), 
      "Same sex couple",
      "Opposite sex couple"
    ),
    income =  ifelse(
      (PINCP <= 20000),
       "$20,000 or less",
      PINCP
    ),
    income = ifelse(
      (PINCP > 20001 & PINCP <= 50000),
       "$20,001 to $50,000",
      income
    ),
    income = ifelse(
      (PINCP > 50001 & PINCP <= 80000),
       "$50,001 to $80,000",
      income
    ),
    income = ifelse(
      (PINCP > 80001 & PINCP <= 100000),
       "$80,001 to $100,000",
      income
    ),
    income = ifelse(
      (PINCP > 100001 & PINCP <= 150000),
       "$100,001 to $150,000",
      income
    ),
    income = ifelse(
      (PINCP > 150001 & PINCP <= 200000),
       "$150,001 to $200,000",
      income
    ),
    income = ifelse(
      (PINCP > 200001 & PINCP <= 250000),
       "$200,001 to $250,000",
      income
    ),
    income = ifelse(
      (PINCP > 250001),
       "$250,001 or more",
      income
    ),
    RAC1P = as.numeric(RAC1P)
  ) %>% 
  filter(
    (RAC1P %in% 3)) #American Indian alone
```


American Indian alone

```{r American Indian Same-Sex Map}
ca_pums_income_same <-
  cleaned %>%
  filter(
    (RAC1P %in% 3)) %>% #American Indian alone  
  mutate(
    PWGTP = as.numeric(PWGTP),
    PINCP = as.numeric(PINCP),
    income =  ifelse(
      ((CPLT == 2)|(CPLT == 4)) & (PINCP <= 50000),
       1,
      0),
    same_sex = ifelse(
        (CPLT == 2)|(CPLT == 4),
        1,
        0
  )) %>% 
  group_by(PUMA) %>% 
  summarize(
    income = sum(income, na.rm = T),
    same_sex_pop = sum(same_sex, na.rm = T)
  ) %>% 
  mutate(
    percent = income/same_sex_pop*100
  ) %>% 
    left_join(
    ca_pumas %>% 
      select(PUMACE10),
    by = c("PUMA" = "PUMACE10")
  ) %>% 
  st_as_sf()

couple_pal <- colorNumeric(
  palette = "Reds",
  domain = 
    c(0,100)
)

leaflet() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addPolygons(
    data = ca_pums_income_same, 
    fillColor = ~couple_pal (percent),
    color = "white",
    opacity = 0.5,
    fillOpacity = 0.75,
    weight = 1,
    label = ~paste0(
      round(percent*100)/100,
      "% people in white same-sex relationships with a personal income of less than $50,000"
    ),
    highlightOptions = highlightOptions(
      weight = 2,
      opacity = 1
    )
  ) %>% 
  addLegend(
    data = ca_pums_income_same,
    pal = couple_pal,
    values = 0:100,
    title = "% same-sex relationships"
  )

```

```{r American Indian Op-Sex Map}
ca_pums_income_op <-
  cleaned %>%
  filter(
    (RAC1P %in% 3)) %>% #American Indian alone  
  mutate(
    PWGTP = as.numeric(PWGTP),
    PINCP = as.numeric(PINCP),
    income =  ifelse(
      ((CPLT == 1)|(CPLT == 3)) & (PINCP <= 50000),
       1,
      0),
    op_sex = ifelse(
        (CPLT == 1)|(CPLT == 3),
        1,
        0
  )) %>% 
  group_by(PUMA) %>% 
  summarize(
    income = sum(income, na.rm = T),
    op_sex_pop = sum(op_sex, na.rm = T)
  ) %>% 
  mutate(
    percent = income/op_sex_pop*100
  ) %>% 
    left_join(
    ca_pumas %>% 
      select(PUMACE10),
    by = c("PUMA" = "PUMACE10")
  ) %>% 
  st_as_sf()

couple_pal <- colorNumeric(
  palette = "Reds",
  domain = 
    c(0,100)
)

leaflet() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addPolygons(
    data = ca_pums_income_op, 
    fillColor = ~couple_pal (percent),
    color = "white",
    opacity = 0.5,
    fillOpacity = 0.75,
    weight = 1,
    label = ~paste0(
      round(percent*100)/100,
      "% people in opposite-sex relationships with a personal income of less than $50,000"
    ),
    highlightOptions = highlightOptions(
      weight = 2,
      opacity = 1
    )
  ) %>% 
  addLegend(
    data = ca_pums_income_op,
    pal = couple_pal,
    values = 0:100,
    title = "% opposite-sex relationships"
  )

```

```{r American Indian CPLT Equity An}
ca_AI_total <-
  ca_pums_IRC %>% 
  group_by(Same_sex_household) %>% 
  summarize(estimate = sum(PWGTP)) %>% 
  mutate(income = "Total")

ca_pums_IRC %>% 
  group_by(income, Same_sex_household) %>% 
  summarize(estimate = sum(PWGTP)) %>% 
  rbind(ca_AI_total) %>%  
  ggplot() +
  geom_bar(
    aes(
      x = income %>% factor(levels = rev(c("Total", mixedsort(order)))),
      y = estimate,
      fill = Same_sex_household %>% factor(levels = rev(unique(ca_pums_IRC$Same_sex_household)))
    ),
    stat = "identity",
    position = "fill"
  ) +
  labs(
    x = "Household income",
    y = "Number of households",
    title = "California household income by couple type",
    fill = "Couple Type"
  ) +
  coord_flip() +
  theme(
    legend.position = "bottom",
    legend.direction = "vertical"
  )  +
  guides(
    fill = guide_legend(
      reverse = T
    )
  )
```

```{r Two or more races-Income}
ca_pums_IRC <-
  cleaned %>%
  mutate(
    PWGTP = as.numeric(PWGTP),
    PINCP = as.numeric(PINCP),
    Same_sex_household = ifelse(
        (CPLT == 2)|(CPLT == 4), 
      "Same sex couple",
      "Opposite sex couple"
    ),
    income =  ifelse(
      (PINCP <= 20000),
       "$20,000 or less",
      PINCP
    ),
    income = ifelse(
      (PINCP > 20001 & PINCP <= 50000),
       "$20,001 to $50,000",
      income
    ),
    income = ifelse(
      (PINCP > 50001 & PINCP <= 80000),
       "$50,001 to $80,000",
      income
    ),
    income = ifelse(
      (PINCP > 80001 & PINCP <= 100000),
       "$80,001 to $100,000",
      income
    ),
    income = ifelse(
      (PINCP > 100001 & PINCP <= 150000),
       "$100,001 to $150,000",
      income
    ),
    income = ifelse(
      (PINCP > 150001 & PINCP <= 200000),
       "$150,001 to $200,000",
      income
    ),
    income = ifelse(
      (PINCP > 200001 & PINCP <= 250000),
       "$200,001 to $250,000",
      income
    ),
    income = ifelse(
      (PINCP > 250001),
       "$250,001 or more",
      income
    ),
    RAC1P = as.numeric(RAC1P)
  ) %>% 
  filter(
    (RAC1P %in% 9)) #Two or More Races
```

Two or More Races
```{r Two or More Map Same-Sex}
ca_pums_income_same <-
  cleaned %>%
  filter(
    (RAC1P %in% 9)) %>% #Two or more 
  mutate(
    PWGTP = as.numeric(PWGTP),
    PINCP = as.numeric(PINCP),
    income =  ifelse(
      ((CPLT == 2)|(CPLT == 4)) & (PINCP <= 50000),
       1,
      0),
    same_sex = ifelse(
        (CPLT == 2)|(CPLT == 4),
        1,
        0
  )) %>% 
  group_by(PUMA) %>% 
  summarize(
    income = sum(income, na.rm = T),
    same_sex_pop = sum(same_sex, na.rm = T)
  ) %>% 
  mutate(
    percent = income/same_sex_pop*100
  ) %>% 
    left_join(
    ca_pumas %>% 
      select(PUMACE10),
    by = c("PUMA" = "PUMACE10")
  ) %>% 
  st_as_sf()

couple_pal <- colorNumeric(
  palette = "Reds",
  domain = 
    c(0,100)
)

leaflet() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addPolygons(
    data = ca_pums_income_same, 
    fillColor = ~couple_pal (percent),
    color = "white",
    opacity = 0.5,
    fillOpacity = 0.75,
    weight = 1,
    label = ~paste0(
      round(percent*100)/100,
      "% people in white same-sex relationships with a personal income of less than $50,000"
    ),
    highlightOptions = highlightOptions(
      weight = 2,
      opacity = 1
    )
  ) %>% 
  addLegend(
    data = ca_pums_income_same,
    pal = couple_pal,
    values = 0:100,
    title = "% same-sex relationships"
  )

```

```{r Two or More Map Op-Sex}
ca_pums_income_op <-
  cleaned %>%
  filter(
    (RAC1P %in% 9)) %>% #Two or more 
  mutate(
    PWGTP = as.numeric(PWGTP),
    PINCP = as.numeric(PINCP),
    income =  ifelse(
      ((CPLT == 1)|(CPLT == 3)) & (PINCP <= 50000),
       1,
      0),
    op_sex = ifelse(
        (CPLT == 1)|(CPLT == 3),
        1,
        0
  )) %>% 
  group_by(PUMA) %>% 
  summarize(
    income = sum(income, na.rm = T),
    op_sex_pop = sum(op_sex, na.rm = T)
  ) %>% 
  mutate(
    percent = income/op_sex_pop*100
  ) %>% 
    left_join(
    ca_pumas %>% 
      select(PUMACE10),
    by = c("PUMA" = "PUMACE10")
  ) %>% 
  st_as_sf()

couple_pal <- colorNumeric(
  palette = "Reds",
  domain = 
    c(0,100)
)

leaflet() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addPolygons(
    data = ca_pums_income_op, 
    fillColor = ~couple_pal (percent),
    color = "white",
    opacity = 0.5,
    fillOpacity = 0.75,
    weight = 1,
    label = ~paste0(
      round(percent*100)/100,
      "% people in opposite-sex relationships with a personal income of less than $50,000"
    ),
    highlightOptions = highlightOptions(
      weight = 2,
      opacity = 1
    )
  ) %>% 
  addLegend(
    data = ca_pums_income_op,
    pal = couple_pal,
    values = 0:100,
    title = "% opposite-sex relationships"
  )

```

```{r Two People Equity Analysis}
ca_two_total <-
  ca_pums_IRC %>% 
  group_by(Same_sex_household) %>% 
  summarize(estimate = sum(PWGTP)) %>% 
  mutate(income = "Total")

ca_pums_IRC %>% 
  group_by(income, Same_sex_household) %>% 
  summarize(estimate = sum(PWGTP)) %>% 
  rbind(ca_two_total) %>%  
  ggplot() +
  geom_bar(
    aes(
      x = income %>% factor(levels = rev(c("Total", mixedsort(order)))),
      y = estimate,
      fill = Same_sex_household %>% factor(levels = rev(unique(ca_pums_IRC$Same_sex_household)))
    ),
    stat = "identity",
    position = "fill"
  ) +
  labs(
    x = "Household income",
    y = "Number of households",
    title = "California household income by couple type",
    fill = "Couple Type"
  ) +
  coord_flip() +
  theme(
    legend.position = "bottom",
    legend.direction = "vertical"
  )  +
  guides(
    fill = guide_legend(
      reverse = T
    )
  )
``` 


Same-Sex gender Equity Analysis 

```{r Same-Sex Gender Equity Analysis Map Average}
ca_pums_income_gender <-
  cleaned %>%
  filter(
    (RAC1P %in% c(1,2,3,6,9)),
    (CPLT %in% c(2, 4))) %>% 
  mutate(
    PWGTP = as.numeric(PWGTP),
    PINCP = as.numeric(PINCP),
    male = ifelse(
      (SEX == 1),
       1,
      0),
    female = ifelse(
      (SEX == 2),
       1,
      0),
    men_inc = ifelse(
      (SEX == 1),
       PINCP,
      0),
    fem_inc = ifelse(
      (SEX == 2),
       PINCP,
      0)
  ) %>% 
  group_by(PUMA) %>% 
  summarize(
    male = sum(male, na.rm = T),
    female = sum(female, na.rm = T),
    incomem = sum(men_inc, na.rm = T),
    incomef = sum(fem_inc, na.rm = T)) %>% 
  mutate(
    average_female_income = incomef/female,
    average_male_income = incomem/male,
    ratio = average_female_income/average_male_income
  ) %>% 
    left_join(
    ca_pumas %>% 
      select(PUMACE10),
    by = c("PUMA" = "PUMACE10")
  ) %>% 
  st_as_sf()

couple_pal <- colorNumeric(
  palette = "Greens",
  domain = 
    c(0,8.5)
)

leaflet() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addPolygons(
    data = ca_pums_income_gender, 
    fillColor = ~couple_pal (ratio),
    color = "white",
    opacity = 0.5,
    fillOpacity = 0.75,
    weight = 1,
    label = ~paste0(
      round(ratio*100)/100,
      "  Women:Men"
    ),
    highlightOptions = highlightOptions(
      weight = 2,
      opacity = 1
    )
  ) %>% 
  addLegend(
    data = ca_pums_income_same,
    pal = couple_pal,
    values = 0:8.5,
    title = "Ratio of personal income Women:Men -- Individuals in same-sex relationship"
  )
```

```{r Map Average}
ca_pums_income_gender <-
  cleaned %>%
  filter(
    (RAC1P %in% c(1,2,3,6,9)),
    (CPLT %in% c(1, 3))) %>% 
  mutate(
    PWGTP = as.numeric(PWGTP),
    PINCP = as.numeric(PINCP),
    male = ifelse(
      (SEX == 1),
       1,
      0),
    female = ifelse(
      (SEX == 2),
       1,
      0),
    men_inc = ifelse(
      (SEX == 1),
       PINCP,
      0),
    fem_inc = ifelse(
      (SEX == 2),
       PINCP,
      0)
  ) %>% 
  group_by(PUMA) %>% 
  summarize(
    male = sum(male, na.rm = T),
    female = sum(female, na.rm = T),
    incomem = sum(men_inc, na.rm = T),
    incomef = sum(fem_inc, na.rm = T)) %>% 
  mutate(
    average_female_income = incomef/female,
    average_male_income = incomem/male,
    ratio = average_female_income/average_male_income
  ) %>% 
    left_join(
    ca_pumas %>% 
      select(PUMACE10),
    by = c("PUMA" = "PUMACE10")
  ) %>% 
  st_as_sf()

couple_pal <- colorNumeric(
  palette = "Greens",
  domain = 
    c(0,8.5)
)

leaflet() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addPolygons(
    data = ca_pums_income_gender, 
    fillColor = ~couple_pal (ratio),
    color = "white",
    opacity = 0.5,
    fillOpacity = 0.75,
    weight = 1,
    label = ~paste0(
      round(ratio*100)/100,
      "  Women:Men"
    ),
    highlightOptions = highlightOptions(
      weight = 2,
      opacity = 1
    )
  ) %>% 
  addLegend(
    data = ca_pums_income_same,
    pal = couple_pal,
    values = 0:8.5,
    title = "Ratio of personal income Women:Men -- Individuals in opposite-sex relationship"
  )
```


```{r same-Sex Gender Equity Analysis}
ca_pums_IRC <-
  cleaned %>%
  filter(
    (CPLT %in% c(2, 4)) #Filtering out opposite-sex couples
  ) %>% 
  mutate(
    PWGTP = as.numeric(PWGTP),
    PINCP = as.numeric(PINCP),
    income =  ifelse(
      (PINCP <= 20000),
       "$20,000 or less",
      PINCP
    ),
    income = ifelse(
      (PINCP > 20001 & PINCP <= 50000),
       "$20,001 to $50,000",
      income
    ),
    income = ifelse(
      (PINCP > 50001 & PINCP <= 80000),
       "$50,001 to $80,000",
      income
    ),
    income = ifelse(
      (PINCP > 80001 & PINCP <= 100000),
       "$80,001 to $100,000",
      income
    ),
    income = ifelse(
      (PINCP > 100001 & PINCP <= 150000),
       "$100,001 to $150,000",
      income
    ),
    income = ifelse(
      (PINCP > 150001 & PINCP <= 200000),
       "$150,001 to $200,000",
      income
    ),
    income = ifelse(
      (PINCP > 200001 & PINCP <= 250000),
       "$200,001 to $250,000",
      income
    ),
    income = ifelse(
      (PINCP > 250001),
       "$250,001 or more",
      income
    ),
    Sex = ifelse(
      (SEX == 1),
      "Male",
      "Female"
    ))  

ca_sex_total <-
  ca_pums_IRC %>% 
  group_by(Sex) %>% 
  summarize(estimate = sum(PWGTP)) %>% 
  mutate(income = "Total")

ca_pums_IRC %>% 
  group_by(income, Sex) %>% 
  summarize(estimate = sum(PWGTP)) %>% 
  rbind(ca_sex_total) %>%  
  ggplot() +
  geom_bar(
    aes(
      x = income %>% factor(levels = rev(c("Total", mixedsort(order)))),
      y = estimate,
      fill = Sex %>% factor(levels = rev(unique(ca_pums_IRC$Sex)))
    ),
    stat = "identity",
    position = "fill"
  ) +
  labs(
    x = "Household income",
    y = "Number of households",
    title = "California personal income by sex: Individuals in same-sex relationships",
    fill = "Gender"
  ) +
  coord_flip() +
  theme(
    legend.position = "bottom",
    legend.direction = "vertical"
  )  +
  guides(
    fill = guide_legend(
      reverse = T
    )
  )
```

```{r Op-Sex Gender Equity An}
ca_pums_IRC <-
  cleaned %>%
  filter(
    (CPLT %in% c(1, 3)) #Filtering out same-sex couples
  ) %>% 
  mutate(
    PWGTP = as.numeric(PWGTP),
    PINCP = as.numeric(PINCP),
    income =  ifelse(
      (PINCP <= 20000),
       "$20,000 or less",
      PINCP
    ),
    income = ifelse(
      (PINCP > 20001 & PINCP <= 50000),
       "$20,001 to $50,000",
      income
    ),
    income = ifelse(
      (PINCP > 50001 & PINCP <= 80000),
       "$50,001 to $80,000",
      income
    ),
    income = ifelse(
      (PINCP > 80001 & PINCP <= 100000),
       "$80,001 to $100,000",
      income
    ),
    income = ifelse(
      (PINCP > 100001 & PINCP <= 150000),
       "$100,001 to $150,000",
      income
    ),
    income = ifelse(
      (PINCP > 150001 & PINCP <= 200000),
       "$150,001 to $200,000",
      income
    ),
    income = ifelse(
      (PINCP > 200001 & PINCP <= 250000),
       "$200,001 to $250,000",
      income
    ),
    income = ifelse(
      (PINCP > 250001),
       "$250,001 or more",
      income
    ),
    Sex = ifelse(
      (SEX == 1),
      "Male",
      "Female"
    ))  

ca_sex_total <-
  ca_pums_IRC %>% 
  group_by(Sex) %>% 
  summarize(estimate = sum(PWGTP)) %>% 
  mutate(income = "Total")

ca_pums_IRC %>% 
  group_by(income, Sex) %>% 
  summarize(estimate = sum(PWGTP)) %>% 
  rbind(ca_sex_total) %>%  
  ggplot() +
  geom_bar(
    aes(
      x = income %>% factor(levels = rev(c("Total", mixedsort(order)))),
      y = estimate,
      fill = Sex %>% factor(levels = rev(unique(ca_pums_IRC$Sex)))
    ),
    stat = "identity",
    position = "fill"
  ) +
  labs(
    x = "Household income",
    y = "Number of households",
    title = "California personal income by sex: Individuals in opposite-sex relationships",
    fill = "Gender"
  ) +
  coord_flip() +
  theme(
    legend.position = "bottom",
    legend.direction = "vertical"
  )  +
  guides(
    fill = guide_legend(
      reverse = T
    )
  )
```


Equity Analysis of single gender and relationship type

```{r men average}
ca_pums_income_male <-
  cleaned %>%
  filter(
    (RAC1P %in% c(1,2,3,6,9)),
    (SEX %in% 1)) %>% 
  mutate(
    PWGTP = as.numeric(PWGTP),
    PINCP = as.numeric(PINCP),
    samesex = ifelse(
      (CPLT == 2)|(CPLT == 4),
       1,
      0),
    op_sex = ifelse(
      (CPLT == 1)|(CPLT == 3),
       1,
      0),
    same_inc = ifelse(
      (CPLT == 2)|(CPLT == 4),
       PINCP,
      0),
    op_inc = ifelse(
      (CPLT == 1)|(CPLT == 3),
       PINCP,
      0)
  ) %>% 
  group_by(PUMA) %>% 
  summarize(
    samesex = sum(samesex, na.rm = T),
    opsex = sum(op_sex, na.rm = T),
    income = sum(same_inc, na.rm = T),
    incomeo = sum(op_inc, na.rm = T)) %>% 
  mutate(
    average_same_income = income/samesex,
    average_op_income = incomeo/opsex,
    ratio = average_same_income/average_op_income
  ) %>% 
    left_join(
    ca_pumas %>% 
      select(PUMACE10),
    by = c("PUMA" = "PUMACE10")
  ) %>% 
  st_as_sf()

couple_pal <- colorNumeric(
  palette = "Greens",
  domain = 
    c(0,4.5)
)

leaflet() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addPolygons(
    data = ca_pums_income_male, 
    fillColor = ~couple_pal (ratio),
    color = "white",
    opacity = 0.5,
    fillOpacity = 0.75,
    weight = 1,
    label = ~paste0(
      round(ratio*100)/100,
      "  Same-Sex:Opposite-Sex"
    ),
    highlightOptions = highlightOptions(
      weight = 2,
      opacity = 1
    )
  ) %>% 
  addLegend(
    data = ca_pums_income_same,
    pal = couple_pal,
    values = 0:5,
    title = "Ratio of personal income Same-Sex:Opposite-Sex-- Men"
  )
  
```

```{r Men Equity Analysis}
ca_pums_IRC <-
  cleaned %>%
  filter(
    (SEX %in% 1) #Filtering out women
  ) %>% 
  mutate(
    PWGTP = as.numeric(PWGTP),
    PINCP = as.numeric(PINCP),
    income =  ifelse(
      (PINCP <= 20000),
       "$20,000 or less",
      PINCP
    ),
    income = ifelse(
      (PINCP > 20001 & PINCP <= 50000),
       "$20,001 to $50,000",
      income
    ),
    income = ifelse(
      (PINCP > 50001 & PINCP <= 80000),
       "$50,001 to $80,000",
      income
    ),
    income = ifelse(
      (PINCP > 80001 & PINCP <= 100000),
       "$80,001 to $100,000",
      income
    ),
    income = ifelse(
      (PINCP > 100001 & PINCP <= 150000),
       "$100,001 to $150,000",
      income
    ),
    income = ifelse(
      (PINCP > 150001 & PINCP <= 200000),
       "$150,001 to $200,000",
      income
    ),
    income = ifelse(
      (PINCP > 200001 & PINCP <= 250000),
       "$200,001 to $250,000",
      income
    ),
    income = ifelse(
      (PINCP > 250001),
       "$250,001 or more",
      income
    ),
    Same_sex_household = ifelse(
        (CPLT == 2)|(CPLT == 4), #Same-sex married couple|same-sex unmarried couple
      "Same sex couple",
      "Opposite sex couple"
      )) 

ca_ct_total <-
  ca_pums_IRC %>% 
  group_by(Same_sex_household) %>% 
  summarize(estimate = sum(PWGTP)) %>% 
  mutate(income = "Total")

ca_pums_IRC %>% 
  group_by(income, Same_sex_household) %>% 
  summarize(estimate = sum(PWGTP)) %>% 
  rbind(ca_ct_total) %>%  
  ggplot() +
  geom_bar(
    aes(
      x = income %>% factor(levels = rev(c("Total", mixedsort(order)))),
      y = estimate,
      fill = Same_sex_household %>% factor(levels = rev(unique(ca_pums_IRC$Same_sex_household)))
    ),
    stat = "identity",
    position = "fill"
  ) +
  labs(
    x = "Household income",
    y = "Number of households",
    title = "California personal income by couple type: Men",
    fill = "Couple Type"
  ) +
  coord_flip() +
  theme(
    legend.position = "bottom",
    legend.direction = "vertical"
  )  +
  guides(
    fill = guide_legend(
      reverse = T
    )
  )
```

```{r women ave}
ca_pums_income_female <-
  cleaned %>%
  filter(
    (RAC1P %in% c(1,2,3,6,9)),
    (SEX %in% 2)) %>% 
  mutate(
    PWGTP = as.numeric(PWGTP),
    PINCP = as.numeric(PINCP),
    samesex = ifelse(
      (CPLT == 2)|(CPLT == 4),
       1,
      0),
    op_sex = ifelse(
      (CPLT == 1)|(CPLT == 3),
       1,
      0),
    same_inc = ifelse(
      (CPLT == 2)|(CPLT == 4),
       PINCP,
      0),
    op_inc = ifelse(
      (CPLT == 1)|(CPLT == 3),
       PINCP,
      0)
  ) %>% 
  group_by(PUMA) %>% 
  summarize(
    samesex = sum(samesex, na.rm = T),
    opsex = sum(op_sex, na.rm = T),
    income = sum(same_inc, na.rm = T),
    incomeo = sum(op_inc, na.rm = T)) %>% 
  mutate(
    average_same_income = income/samesex,
    average_op_income = incomeo/opsex,
    ratio = average_same_income/average_op_income
  ) %>% 
    left_join(
    ca_pumas %>% 
      select(PUMACE10),
    by = c("PUMA" = "PUMACE10")
  ) %>% 
  st_as_sf()

couple_pal <- colorNumeric(
  palette = "Greens",
  domain = 
    c(0,4.5)
)

leaflet() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addPolygons(
    data = ca_pums_income_female, 
    fillColor = ~couple_pal (ratio),
    color = "white",
    opacity = 0.5,
    fillOpacity = 0.75,
    weight = 1,
    label = ~paste0(
      round(ratio*100)/100,
      "  Same-Sex:Opposite-Sex"
    ),
    highlightOptions = highlightOptions(
      weight = 2,
      opacity = 1
    )
  ) %>% 
  addLegend(
    data = ca_pums_income_same,
    pal = couple_pal,
    values = 0:5,
    title = "Ratio of personal income Same-Sex:Opposite-Sex-- Women"
  )
  
```

```{r Women Equity Analysis}
ca_pums_IRC <-
  cleaned %>%
  filter(
    (SEX %in% 2) #Filtering out men
  ) %>% 
  mutate(
    PWGTP = as.numeric(PWGTP),
    PINCP = as.numeric(PINCP),
    income =  ifelse(
      (PINCP <= 20000),
       "$20,000 or less",
      PINCP
    ),
    income = ifelse(
      (PINCP > 20001 & PINCP <= 50000),
       "$20,001 to $50,000",
      income
    ),
    income = ifelse(
      (PINCP > 50001 & PINCP <= 80000),
       "$50,001 to $80,000",
      income
    ),
    income = ifelse(
      (PINCP > 80001 & PINCP <= 100000),
       "$80,001 to $100,000",
      income
    ),
    income = ifelse(
      (PINCP > 100001 & PINCP <= 150000),
       "$100,001 to $150,000",
      income
    ),
    income = ifelse(
      (PINCP > 150001 & PINCP <= 200000),
       "$150,001 to $200,000",
      income
    ),
    income = ifelse(
      (PINCP > 200001 & PINCP <= 250000),
       "$200,001 to $250,000",
      income
    ),
    income = ifelse(
      (PINCP > 250001),
       "$250,001 or more",
      income
    ),
    Same_sex_household = ifelse(
        (CPLT == 2)|(CPLT == 4), #Same-sex married couple|same-sex unmarried couple
      "Same sex couple",
      "Opposite sex couple"
      )) 

ca_ct_total <-
  ca_pums_IRC %>% 
  group_by(Same_sex_household) %>% 
  summarize(estimate = sum(PWGTP)) %>% 
  mutate(income = "Total")

ca_pums_IRC %>% 
  group_by(income, Same_sex_household) %>% 
  summarize(estimate = sum(PWGTP)) %>% 
  rbind(ca_ct_total) %>%  
  ggplot() +
  geom_bar(
    aes(
      x = income %>% factor(levels = rev(c("Total", mixedsort(order)))),
      y = estimate,
      fill = Same_sex_household %>% factor(levels = rev(unique(ca_pums_IRC$Same_sex_household)))
    ),
    stat = "identity",
    position = "fill"
  ) +
  labs(
    x = "Household income",
    y = "Number of households",
    title = "California personal income by couple type: Women",
    fill = "Couple Type"
  ) +
  coord_flip() +
  theme(
    legend.position = "bottom",
    legend.direction = "vertical"
  )  +
  guides(
    fill = guide_legend(
      reverse = T
    )
  )
```

















































